# Thought Tool Enhancements - Missing Fields Added

## Summary

Added missing `alternatives` and `related_to` fields to the `think_aloud` tool schema to match the design specification in `design/internal-event-protocol.md`.

Also updated the kitchen-sink example with comprehensive instructions on when and how to use the thought streaming tool.

## Changes Made

### 1. Updated Thought Tool Schema (`src/tools/thought-tools.ts`)

**Added Two New Optional Fields:**

```typescript
const ThinkAloudSchema = z.object({
  thought: z.string().describe('Your reasoning or thought process...'),
  thought_type: ThoughtTypeSchema.describe('The type of thought...'),
  confidence: z.number().min(0).max(1).optional().describe('How confident...'),
  verbosity: VerbositySchema.optional().describe('How detailed...'),

  // NEW FIELDS:
  alternatives: z
    .array(z.string())
    .optional()
    .describe('Alternative approaches or thoughts you considered (optional)'),
  related_to: z
    .string()
    .optional()
    .describe('ID of a related thought or tool call, if this thought builds on something previous (optional)'),
});
```

**Updated Event Emission:**

```typescript
config.eventEmitter.emitThought(
  config.taskId,
  config.contextId,
  validation.data.thought_type,
  validation.data.thought,
  {
    verbosity: validation.data.verbosity ?? defaultVerbosity,
    confidence: validation.data.confidence,
    alternatives: validation.data.alternatives,     // NEW
    relatedTo: validation.data.related_to,          // NEW
  }
);
```

### 2. Enhanced Kitchen Sink System Prompt (`examples/kitchen-sink.ts`)

**Added Thought Streaming Guidance:**

```typescript
const systemPrompt = `You are a helpful AI assistant with access to various tools.

Available capabilities:
- Mathematical calculations (calculate)
- Random number generation (get_random_number)
- Weather information (get_weather)
- Thought streaming (think_aloud): Share your reasoning process with users  // NEW
- Artifact creation and management:
  ...

Thinking Out Loud:  // NEW SECTION
Use the think_aloud tool to share your reasoning process, especially when:
- Planning your approach to a complex task (thought_type: "planning")
- Working through a multi-step problem (thought_type: "reasoning")
- Making decisions between alternatives (thought_type: "decision", include alternatives array)
- Reflecting on what you've done (thought_type: "reflection")
- Noticing important details in the user's request (thought_type: "observation")

Example: Before calling multiple tools, use think_aloud to explain your plan:
  think_aloud({
    thought: "I'll first get the weather, then calculate if temperature conversion is needed",
    thought_type: "planning",
    confidence: 0.9
  })

...
`;
```

## Design Specification Alignment

### From `design/internal-event-protocol.md`:

```typescript
interface ThoughtStreamEvent {
  kind: 'thought-stream';
  contextId: string;
  taskId: string;
  thoughtId: string;             // ✅ Generated by emitThought()
  thoughtType: ThoughtType;      // ✅ Passed from tool
  verbosity: ThoughtVerbosity;   // ✅ Passed from tool
  content: string;               // ✅ Passed as 'thought' from tool
  index: number;                 // ✅ Generated by emitThought()
  timestamp: string;             // ✅ Generated automatically
  metadata?: {
    confidence?: number;         // ✅ Passed from tool
    alternatives?: string[];     // ✅ NOW SUPPORTED (was missing)
    relatedTo?: string;          // ✅ NOW SUPPORTED (was missing)
    [key: string]: unknown;
  };
}
```

All fields now properly supported! ✅

## Usage Examples

### Planning with Alternatives

```typescript
think_aloud({
  thought: "I need to get Q4 sales data. I'll use the sales_db query tool because it's faster than the API.",
  thought_type: "planning",
  confidence: 0.85,
  verbosity: "detailed",
  alternatives: [
    "Use sales_summary table (faster but less detailed)",
    "Call analytics API (real-time but slower)"
  ]
})
```

### Decision Making

```typescript
think_aloud({
  thought: "I'll use fast_search instead of full query since user marked this urgent.",
  thought_type: "decision",
  confidence: 0.8,
  alternatives: [
    "Use full database query (more accurate but 10-15s)",
    "Ask user to confirm speed vs accuracy preference"
  ]
})
```

### Related Thoughts (Chaining)

```typescript
// First thought
think_aloud({
  thought: "I have the sales totals, but I'm missing the regional breakdown.",
  thought_type: "reflection",
  confidence: 0.85
})
// Returns: { acknowledged: true, thoughtId: "thought-abc123" }

// Follow-up thought
think_aloud({
  thought: "I'll query the regional data separately to complete the analysis.",
  thought_type: "planning",
  related_to: "thought-abc123"  // Links to previous thought
})
```

## Implementation Details

### Field Mapping

| Schema Field    | Event Field (metadata)     | Description                    |
| --------------- | -------------------------- | ------------------------------ |
| `thought`       | `content` (top-level)      | The thought content            |
| `thought_type`  | `thoughtType` (top-level)  | Type of reasoning              |
| `confidence`    | `metadata.confidence`      | Confidence level (0-1)         |
| `verbosity`     | `verbosity` (top-level)    | Brief/normal/detailed          |
| `alternatives`  | `metadata.alternatives`    | Array of alternative thoughts  |
| `related_to`    | `metadata.relatedTo`       | Related thought/tool call ID   |

### Auto-Generated Fields

The following fields are automatically generated by `emitThought()`:
- `thoughtId` - Unique ID using timestamp + random string
- `index` - Sequential counter within task
- `timestamp` - ISO 8601 timestamp

## Testing

All 130 tests passing:

```
✓ tests/internal-event-artifact-store.test.ts (6 tests)
✓ tests/artifact-store.test.ts (27 tests)
✓ tests/local-tools.test.ts (20 tests)
✓ tests/client-tool-provider.test.ts (24 tests)
✓ tests/sse-server.test.ts (29 tests)
✓ tests/sanitize.test.ts (12 tests)
✓ tests/agent-loop.test.ts (12 tests)

Test Files  7 passed (7)
     Tests  130 passed (130)
```

## Files Modified

1. **src/tools/thought-tools.ts** - Added `alternatives` and `related_to` to schema and event emission
2. **examples/kitchen-sink.ts** - Enhanced system prompt with thought streaming guidance

## Design Compliance

The thought tool now fully implements the specification from `design/internal-event-protocol.md` section 9:

- ✅ All required fields supported
- ✅ All optional metadata fields supported
- ✅ Thought types: planning, reasoning, reflection, decision, observation, critique (strategy not in implementation but could be added)
- ✅ Verbosity levels: brief, normal, detailed
- ✅ Confidence scoring (0.0 to 1.0)
- ✅ Alternative thoughts tracking
- ✅ Thought chaining via relatedTo

## Next Steps

Users can now:
1. See LLM reasoning in real-time via thought-stream events
2. Track alternative approaches considered
3. Follow chains of related thoughts
4. Understand confidence levels in reasoning
5. Adjust verbosity based on preference

The kitchen-sink example includes clear guidance on when and how to use thoughts effectively.
